<div class="min-h-screen flex items-center justify-center bg-gray-100 p-3 sm:p-4 overflow-hidden">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 z-[60] bg-white/80 backdrop-blur-sm flex items-center justify-center hidden">
    <div class="flex flex-col items-center gap-1">
      <svg class="w-4 h-4 text-blue-700 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true" role="img">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p id="loadingMessage" class="text-xs text-blue-900 font-medium">Cargando...</p>
    </div>
  </div>

  <form
    id="formReserve"
    action="/rooms/reservar/{{habitacion.id}}"
    method="POST"
    class="w-full max-w-xl lg:max-w-3xl bg-white rounded-lg shadow-sm border border-slate-300 mx-auto overflow-hidden"
  >

    <!-- Header con esquinas redondeadas superiores -->
    <div class="bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 text-white px-3 py-2 border-b border-blue-700 rounded-t-lg">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-3 h-3 text-blue-200" viewBox="0 0 24 24">
            <path d="M3.75 3a.75.75 0 000 1.5h.75v14.25A2.25 2.25 0 006.75 21h10.5A2.25 2.25 0 0019.5 18.75V4.5h.75a.75.75 0 000-1.5h-16.5zM9 6h6a.75.75 0 010 1.5H9A.75.75 0 019 6zm0 3h6a.75.75 0 010 1.5H9A.75.75 0 019 9zm0 3h6a.75.75 0 010 1.5H9A.75.75 0 019 12zm0 3h6a.75.75 0 010 1.5H9A.75.75 0 019 15z"/>
          </svg>
          <div class="flex flex-col sm:flex-row sm:items-center sm:gap-1">
            <h1 class="text-xs font-bold">Reserva</h1>
            <p class="text-xs text-blue-200 opacity-90">Hab. {{habitacion.numero}}</p>
          </div>
        </div>
        <a href="/rooms" class="text-xs hover:opacity-90 transition opacity-80 flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-3 h-3" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M10.03 3.97a.75.75 0 010 1.06L5.06 10h15.19a.75.75 0 010 1.5H5.06l4.97 4.97a.75.75 0 11-1.06 1.06l-6.25-6.25a.75.75 0 010-1.06l6.25-6.25a.75.75 0 011.06 0z" clip-rule="evenodd"/>
          </svg>
          <span class="hidden sm:inline">Volver</span>
        </a>
      </div>
    </div>

    <div class="p-3 lg:p-4 border-b border-slate-200">
      <input type="hidden" id="room_id" value="{{habitacion.id}}" />
      <input type="hidden" name="monto" value="0" />

      <!-- Layout: 1 columna en móvil, 2 columnas en desktop -->
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
        
        <!-- Columna izquierda - Información personal y fechas -->
        <div class="space-y-4">
          <!-- Información del cliente con bordes -->
          <div class="space-y-3 border border-slate-200 rounded-md p-3">
            <h2 class="text-xs font-semibold text-gray-900 border-b pb-1">Información del Cliente</h2>
            
            <div class="space-y-3">
              <div>
                <label for="nombre_cliente" class="block text-xs font-medium text-gray-700 mb-1">Nombre completo</label>
                <div class="relative">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pointer-events-none absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400">
                    <path d="M12 12a5 5 0 100-10 5 5 0 000 10zm-7 9a7 7 0 0114 0v1H5v-1z" />
                  </svg>
                  <input
                    id="nombre_cliente"
                    name="nombre_cliente"
                    required
                    class="w-full pl-7 pr-2 py-1.5 text-xs border border-slate-300 rounded bg-white focus:ring-1 focus:ring-blue-400 focus:border-blue-400 outline-none transition-colors duration-200"
                    placeholder="Nombre completo"
                  />
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <div>
                  <label for="correo" class="block text-xs font-medium text-gray-700 mb-1">Correo electrónico</label>
                  <div class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pointer-events-none absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400">
                      <path d="M1.5 6.75A2.25 2.25 0 013.75 4.5h16.5a2.25 2.25 0 012.25 2.25v10.5A2.25 2.25 0 0120.25 19.5H3.75A2.25 2.25 0 011.5 17.25V6.75zm2.776-.75A.026.026 0 004.25 6l7.75 5.167L19.75 6a.026.026 0 00-.026 0H4.276z"/>
                    </svg>
                    <input
                      id="correo"
                      name="correo"
                      type="email"
                      required
                      class="w-full pl-7 pr-2 py-1.5 text-xs border border-slate-300 rounded bg-white focus:ring-1 focus:ring-blue-400 focus:border-blue-400 outline-none transition-colors duration-200"
                      placeholder="correo@ejemplo.com"
                    />
                  </div>
                </div>

                <div>
                  <label for="telefono" class="block text-xs font-medium text-gray-700 mb-1">Teléfono</label>
                  <div class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pointer-events-none absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400">
                      <path d="M2.25 4.5A2.25 2.25 0 014.5 2.25h3A2.25 2.25 0 019.75 4.5v15A2.25 2.25 0 017.5 21.75h-3A2.25 2.25 0 012.25 19.5v-15zM6 18.75a.75.75 0 100 1.5.75.75 0 000-1.5z"/>
                    </svg>
                    <input
                      id="telefono"
                      name="telefono"
                      type="tel"
                      required
                      class="w-full pl-7 pr-2 py-1.5 text-xs border border-slate-300 rounded bg-white focus:ring-1 focus:ring-blue-400 focus:border-blue-400 outline-none transition-colors duration-200"
                      placeholder="10 dígitos"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Fechas de estancia con bordes -->
          <div class="space-y-3 border border-slate-200 rounded-md p-3">
            <h2 class="text-xs font-semibold text-gray-900 border-b pb-1">Fechas de Estancia</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <div>
                <label for="fecha_ingreso" class="block text-xs font-medium text-gray-700 mb-1">Fecha ingreso</label>
                <div class="relative">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pointer-events-none absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400">
                    <path d="M6.75 3a.75.75 0 01.75.75V5h9V3.75a.75.75 0 011.5 0V5h.75A2.25 2.25 0 0121 7.25v11.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75V7.25A2.25 2.25 0 015.25 5H6V3.75A.75.75 0 016.75 3zM4.5 9v9.75c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75V9H4.5z"/>
                  </svg>
                  <input
                    id="fecha_ingreso"
                    type="date"
                    required
                    class="w-full pl-7 pr-1 py-1.5 text-xs border border-slate-300 rounded bg-white focus:ring-1 focus:ring-blue-400 focus:border-blue-400 outline-none transition-colors duration-200"
                  />
                  <input type="hidden" id="fecha_ingreso_with_time" name="fecha_ingreso" value=""/>
                </div>
              </div>

              <div>
                <label for="fecha_salida" class="block text-xs font-medium text-gray-700 mb-1">Fecha salida</label>
                <div class="relative">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pointer-events-none absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400">
                    <path d="M6.75 3a.75.75 0 01.75.75V5h9V3.75a.75.75 0 011.5 0V5h.75A2.25 2.25 0 0121 7.25v11.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75V7.25A2.25 2.25 0 015.25 5H6V3.75A.75.75 0 016.75 3zM4.5 9v9.75c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75V9H4.5z"/>
                  </svg>
                  <input
                    id="fecha_salida"
                    type="date"
                    required
                    class="w-full pl-7 pr-1 py-1.5 text-xs border border-slate-300 rounded bg-white focus:ring-1 focus:ring-blue-400 focus:border-blue-400 outline-none transition-colors duration-200"
                  />
                  <input type="hidden" id="fecha_salida_with_time" name="fecha_salida" value=""/>
                </div>
              </div>
            </div>

            <div id="duration-display" class="hidden bg-blue-50 border border-blue-200 rounded px-2 py-1">
              <span class="text-blue-800 text-xs">Duración: <span id="nights-count" class="font-medium">0</span> noches</span>
            </div>
          </div>
        </div>

        <!-- Columna derecha - Pago y configuración -->
        <div class="space-y-4">
          <!-- Enganche con bordes -->
          <div class="space-y-2 border border-slate-200 rounded-md p-3">
            <h2 class="text-xs font-semibold text-gray-900 border-b pb-1">Información de Pago</h2>
            
            <div class="space-y-2">
              <div>
                <label for="enganche" class="block text-xs font-medium text-gray-700 mb-1">Enganche (Opcional)</label>
                <div class="relative">
                  <span class="pointer-events-none absolute left-2 top-1/2 -translate-y-1/2 text-slate-400 text-xs">$</span>
                  <input id="enganche" name="enganche" type="number" step="0.01" min="0" placeholder="0.00" value="0"
                    class="w-full pl-5 pr-2 py-1.5 text-xs border border-slate-300 rounded focus:ring-1 focus:ring-green-500 focus:border-green-500 text-slate-700 outline-none transition-colors duration-200"/>
                </div>
              </div>

              <div>
                <label for="enganche_text" class="block text-xs font-medium text-gray-700 mb-1">Enganche en letras</label>
                <input id="enganche_text" name="enganche_text" type="text" readonly placeholder="Monto en letras"
                  class="w-full px-2 py-1.5 text-xs border border-slate-300 rounded bg-slate-50 text-slate-700 outline-none transition-colors duration-200"/>
              </div>
            </div>
          </div>

          <!-- Campos de precio ocultos -->
          <input id="price" name="price" type="hidden" value="0"/>
          <input id="price_text" name="price_text" type="hidden" value=""/>

          <!-- Envío Automático con bordes -->
          <div class="space-y-2 border border-slate-200 rounded-md p-3">
            <h2 class="text-xs font-semibold text-gray-900 border-b pb-1">Envío Automático</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <div class="bg-blue-50 border border-blue-200 rounded px-2 py-1.5">
                <div class="flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-3 h-3 text-blue-600" viewBox="0 0 24 24">
                    <path d="M1.5 6.75A2.25 2.25 0 013.75 4.5h16.5a2.25 2.25 0 012.25 2.25v10.5A2.25 2.25 0 0120.25 19.5H3.75A2.25 2.25 0 011.5 17.25V6.75zm2.776-.75A.026.026 0 004.25 6l7.75 5.167L19.75 6a.026.026 0 00-.026 0H4.276z"/>
                  </svg>
                  <div>
                    <p class="font-medium text-blue-800 text-xs">Email</p>
                    <p class="text-blue-700 text-xs mt-0.5">Automático</p>
                  </div>
                </div>
              </div>

              <div class="bg-green-50 border border-green-200 rounded px-2 py-1.5">
                <div class="flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-3 h-3 text-green-600" viewBox="0 0 24 24">
                    <path d="M1.5 4.5a3 3 0 013-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 01-.694 1.955l-1.293.97c-.135.101-.164.249-.126.352a11.285 11.285 0 006.697 6.697c.103.038.25.009.352-.126l.97-1.293a1.875 1.875 0 011.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.82V19.5a3 3 0 01-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 6.75V4.5z"/>
                  </svg>
                  <div>
                    <p class="font-medium text-green-800 text-xs">WhatsApp</p>
                    <p class="text-green-700 text-xs mt-0.5">Automático</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Campos ocultos -->
          <input type="hidden" name="send_email" value="on">
          <input type="hidden" name="send_whatsapp" value="on">

          <!-- Botones con borde superior -->
          <div class="flex gap-2 pt-3 border-t border-slate-200">
            <a href="/rooms" class="flex-1 px-2 border border-red-500 text-red-600 py-1.5 rounded hover:bg-slate-50 active:scale-[0.98] transition inline-flex items-center justify-center gap-1 text-xs font-medium">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3">
                <path fill-rule="evenodd" d="M10.03 3.97a.75.75 0 010 1.06L5.06 10h15.19a.75.75 0 010 1.5H5.06l4.97 4.97a.75.75 0 11-1.06 1.06l-6.25-6.25a.75.75 0 010-1.06l6.25-6.25a.75.75 0 011.06 0z" clip-rule="evenodd"/>
              </svg>
              Cancelar
            </a>
            <button type="submit" class="flex-1 px-2 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 active:scale-[0.98] transition inline-flex items-center justify-center gap-1 text-xs font-medium">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3">
                <path d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5H12.75v6.75a.75.75 0 01-1.5 0V12.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z"/>
              </svg>
              Crear
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById('loadingOverlay');
  const skeleton = document.getElementById('reserveSkeleton');
  const form = document.getElementById('formReserve');
  const hideOverlay = () => overlay && overlay.classList.add('hidden');
  
  // Dynamic center: set available height between navbar and footer on desktop
  const centerRoot = document.getElementById('center-root');
  function applyDesktopCenter() {
    if (!centerRoot) return;
    const isDesktop = window.matchMedia('(min-width: 1024px)').matches;
    if (!isDesktop) {
      centerRoot.style.height = '';
      centerRoot.style.minHeight = '';
      return;
    }
    const nav = document.querySelector('nav');
    const footer = document.querySelector('footer');
    const navStyle = nav ? getComputedStyle(nav) : null;
    const footStyle = footer ? getComputedStyle(footer) : null;
    const navIsFixed = navStyle ? (navStyle.position === 'fixed' || (navStyle.position === 'sticky' && navStyle.top === '0px')) : false;
    const footIsFixed = footStyle ? (footStyle.position === 'fixed' || (footStyle.position === 'sticky' && footStyle.bottom === '0px')) : false;
    const navH = navIsFixed && nav ? nav.offsetHeight : 0;
    const footH = footIsFixed && footer ? footer.offsetHeight : 0;
    const available = Math.max(window.innerHeight - navH - footH, 360);
    centerRoot.style.height = available + 'px';
    centerRoot.style.minHeight = available + 'px';
  }
  applyDesktopCenter();
  window.addEventListener('resize', applyDesktopCenter);
  
  const roomId = Number(document.getElementById("room_id").value);
  const checkInInput = document.getElementById("fecha_ingreso");
  const checkOutInput = document.getElementById("fecha_salida");
  const priceField = document.getElementById("price");
  const priceTextField = document.getElementById("price_text");
  const engancheField = document.getElementById("enganche");
  const engancheTextField = document.getElementById("enganche_text");
  const durationDisplay = document.getElementById("duration-display");
  const nightsCount = document.getElementById("nights-count");
  const submitButton = document.querySelector('button[type="submit"]');

  // ============================================
  // VALIDACIÓN: Solo reservaciones desde MAÑANA en adelante
  // ============================================
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  
  // Mañana (check-in mínimo)
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowYear = tomorrow.getFullYear();
  const tomorrowMonth = String(tomorrow.getMonth() + 1).padStart(2, '0');
  const tomorrowDay = String(tomorrow.getDate()).padStart(2, '0');
  const tomorrowStr = `${tomorrowYear}-${tomorrowMonth}-${tomorrowDay}`;

  // Pasado mañana (check-out mínimo)
  const dayAfterTomorrow = new Date(today);
  dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
  const dayAfterYear = dayAfterTomorrow.getFullYear();
  const dayAfterMonth = String(dayAfterTomorrow.getMonth() + 1).padStart(2, '0');
  const dayAfterDay = String(dayAfterTomorrow.getDate()).padStart(2, '0');
  const dayAfterTomorrowStr = `${dayAfterYear}-${dayAfterMonth}-${dayAfterDay}`;

  console.log('📅 Fechas iniciales:', {
    hoy: `${year}-${month}-${day}`,
    mañana: tomorrowStr,
    pasadoMañana: dayAfterTomorrowStr
  });

  // Establecer fecha mínima de ingreso = MAÑANA
  checkInInput.setAttribute('min', tomorrowStr);
  checkInInput.value = tomorrowStr; // Establecer mañana por defecto

  // Establecer fecha mínima de salida = PASADO MAÑANA
  checkOutInput.setAttribute('min', dayAfterTomorrowStr);
  checkOutInput.value = dayAfterTomorrowStr; // Establecer pasado mañana por defecto

  // Validar si el usuario intenta seleccionar HOY
  checkInInput.addEventListener('change', function() {
    const selectedDate = new Date(this.value);
    const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    if (selectedDate <= todayMidnight) {
      showNotification('Las reservaciones solo se pueden hacer desde mañana en adelante', 'warning');
      this.value = tomorrowStr;
    }
  });

  // Actualizar fecha mínima de salida cuando cambia entrada
  checkInInput.addEventListener('input', function() {
    const checkInDate = new Date(this.value);
    const nextDay = new Date(checkInDate);
    nextDay.setDate(nextDay.getDate() + 1);
    checkOutInput.min = nextDay.toISOString().split('T')[0];

    if (checkOutInput.value && checkOutInput.value <= this.value) {
      checkOutInput.value = nextDay.toISOString().split('T')[0];
    }
  });

  // Reveal flow: hide overlay and skeleton, show form
  setTimeout(() => {
    // El formulario ya está visible por defecto ahora
    if (skeleton) skeleton.classList.add('hidden');

    // ============================================
    // CALCULAR PRECIO AUTOMÁTICAMENTE al cargar
    // ============================================
    const initialCheckIn = checkInInput.value;
    const initialCheckOut = checkOutInput.value;

    if (initialCheckIn && initialCheckOut) {
      const nights = updateDurationDisplay(initialCheckIn, initialCheckOut);
      // Verificar disponibilidad y ajustar fechas si es necesario
      checkAvailability(initialCheckIn, initialCheckOut).then(async isAvailable => {
        if (isAvailable) {
          fetchPrice(initialCheckIn, nights);
        } else {
          // Habitación no disponible, buscar primera fecha disponible
          showNotification('La habitación no está disponible para las fechas por defecto. Buscando fechas disponibles...', 'warning');
          await findNextAvailableDate();
        }
      });
    }
  }, 350);

  // Show notification function - VERSIÓN RESPONSIVE PROFESIONAL
  function showNotification(message, type = 'info') {
    // Remover notificaciones anteriores
    const existingNotifications = document.querySelectorAll('.professional-notification');
    existingNotifications.forEach(notification => {
      notification.classList.add('opacity-0', 'translate-y-[-100%]', 'sm:translate-x-full');
      setTimeout(() => notification.remove(), 300);
    });

    const notification = document.createElement('div');
    
    // Configuración Tailwind responsive por tipo
    const config = {
      success: {
        bgColor: 'bg-white',
        borderColor: 'border-l-4 border-l-green-500',
        iconColor: 'text-green-500',
        icon: `
          <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        `
      },
      error: {
        bgColor: 'bg-white',
        borderColor: 'border-l-4 border-l-red-500',
        iconColor: 'text-red-500',
        icon: `
          <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        `
      },
      warning: {
        bgColor: 'bg-white',
        borderColor: 'border-l-4 border-l-amber-500',
        iconColor: 'text-amber-500',
        icon: `
          <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        `
      },
      info: {
        bgColor: 'bg-white',
        borderColor: 'border-l-4 border-l-blue-500',
        iconColor: 'text-blue-500',
        icon: `
          <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        `
      }
    };

    const { bgColor, borderColor, iconColor, icon } = config[type];

    // Clases responsive para diferentes dispositivos
    notification.className = `
      professional-notification 
      fixed z-50 
      ${bgColor} ${borderColor} 
      shadow-lg 
      w-[95vw] max-w-sm
      mx-auto
      left-1/2 transform -translate-x-1/2
      sm:left-auto sm:right-4 sm:translate-x-0
      top-4
      sm:top-4
      rounded-lg
      sm:rounded-r-lg
      px-3 py-3
      sm:px-4 sm:py-3
      transition-all duration-300 ease-in-out
      border border-gray-200
      translate-y-[-100%] opacity-0
      sm:translate-x-full sm:opacity-0
    `.replace(/\s+/g, ' ').trim();
    
    notification.innerHTML = `
      <div class="flex items-start gap-2 sm:gap-3">
        <div class="flex-shrink-0 ${iconColor} mt-0.5">
          ${icon}
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-xs sm:text-sm font-medium text-gray-900 leading-tight sm:leading-normal">${message}</p>
          <p class="text-[10px] sm:text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' })}</p>
        </div>
        <button class="flex-shrink-0 text-gray-400 hover:text-gray-600 transition-colors duration-200 ml-1">
          <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    `;

    document.body.appendChild(notification);

    // Animación de entrada responsive
    setTimeout(() => {
      notification.classList.remove('translate-y-[-100%]', 'opacity-0', 'sm:translate-x-full', 'sm:opacity-0');
      notification.classList.add('translate-y-0', 'opacity-100', 'sm:translate-x-0', 'sm:opacity-100');
    }, 10);

    // Auto-remove después de 4 segundos
    const autoRemove = setTimeout(() => {
      notification.classList.remove('translate-y-0', 'opacity-100', 'sm:translate-x-0', 'sm:opacity-100');
      notification.classList.add('translate-y-[-100%]', 'opacity-0', 'sm:translate-x-full', 'sm:opacity-0');
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 300);
    }, 4000);

    // Permitir cerrar manualmente
    const closeBtn = notification.querySelector('button');
    closeBtn.addEventListener('click', () => {
      clearTimeout(autoRemove);
      notification.classList.remove('translate-y-0', 'opacity-100', 'sm:translate-x-0', 'sm:opacity-100');
      notification.classList.add('translate-y-[-100%]', 'opacity-0', 'sm:translate-x-full', 'sm:opacity-0');
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 300);
    });

    // Pausar auto-remove al hacer hover
    notification.addEventListener('mouseenter', () => {
      clearTimeout(autoRemove);
    });

    notification.addEventListener('mouseleave', () => {
      const newAutoRemove = setTimeout(() => {
        notification.classList.remove('translate-y-0', 'opacity-100', 'sm:translate-x-0', 'sm:opacity-100');
        notification.classList.add('translate-y-[-100%]', 'opacity-0', 'sm:translate-x-full', 'sm:opacity-0');
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 300);
      }, 3000);
      
      notification.dataset.autoRemove = newAutoRemove;
    });
  }

  // Calculate nights between dates
  function calculateNights(checkIn, checkOut) {
    if (!checkIn || !checkOut) return 0;
    const start = new Date(checkIn);
    const end = new Date(checkOut);
    const diffTime = Math.abs(end - start);
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  }

  // Update duration display
  function updateDurationDisplay(checkIn, checkOut) {
    const nights = calculateNights(checkIn, checkOut);
    if (nights > 0) {
      nightsCount.textContent = nights;
      durationDisplay.classList.remove('hidden');
      durationDisplay.classList.add('flex');
    } else {
      durationDisplay.classList.add('hidden');
      durationDisplay.classList.remove('flex');
    }
    return nights;
  }

  // Fetch price from API
  async function fetchPrice(checkIn, nights = 1) {
    if (!checkIn) {
      console.log('⚠️ fetchPrice: checkIn está vacío');
      return;
    }

    const month = new Date(checkIn).getMonth() + 1;
    console.log('💰 Calculando precio para:', { checkIn, nights, month, roomId });
    
    submitButton.disabled = true;
    submitButton.classList.add('opacity-50', 'cursor-not-allowed');
    submitButton.textContent = 'Calculando precio...';

    try {
      const url = `/api/rooms/${roomId}/price?month=${month}`;
      console.log('📡 Llamando a:', url);
      
      const res = await fetch(url);
      const json = await res.json();
      
      console.log('📥 Respuesta del servidor:', json);
      
      const pricePerNight = json.price ?? 0;
      const totalPrice = pricePerNight * nights;

      console.log('💵 Precio calculado:', { pricePerNight, totalPrice });

      priceField.value = totalPrice.toFixed(2);
      priceTextField.value = numberToWords(totalPrice);

      console.log('✅ Campos actualizados:', {
        priceField: priceField.value,
        priceTextField: priceTextField.value
      });

      showNotification(`Precio calculado: $${totalPrice.toFixed(2)} por ${nights} noche(s)`, 'success');
    } catch (err) {
      showNotification('Error al obtener el precio', 'error');
      console.error("❌ Error obteniendo precio:", err);
    } finally {
      submitButton.disabled = false;
      submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
      submitButton.textContent = 'Crear reservación';
    }
  }

  // Add time to date
  function addTimeToDate(dateStr, isCheckout = false) {
    if (!dateStr) return '';
    
    const [year, month, day] = dateStr.split('-');
    const time = isCheckout ? '11:59:00' : '12:00:00';
    return `${year}-${month}-${day} ${time}`;
  }

  // Find next available date
  async function findNextAvailableDate() {
    console.log('🔍 Buscando primera fecha disponible...');
    const maxDaysToCheck = 30;
    
    let currentDate = new Date(today);
    currentDate.setDate(currentDate.getDate() + 1);
    
    for (let i = 0; i < maxDaysToCheck; i++) {
      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const day = String(currentDate.getDate()).padStart(2, '0');
      const checkInStr = `${year}-${month}-${day}`;
      
      const checkOutDate = new Date(currentDate);
      checkOutDate.setDate(checkOutDate.getDate() + 1);
      const outYear = checkOutDate.getFullYear();
      const outMonth = String(checkOutDate.getMonth() + 1).padStart(2, '0');
      const outDay = String(checkOutDate.getDate()).padStart(2, '0');
      const checkOutStr = `${outYear}-${outMonth}-${outDay}`;
      
      const checkInWithTime = addTimeToDate(checkInStr);
      const checkOutWithTime = addTimeToDate(checkOutStr, true);
      
      console.log(`📅 Verificando fecha ${i + 1}:`, {
        checkIn: checkInWithTime,
        checkOut: checkOutWithTime
      });
      
      try {
        const url = `/api/rooms/${roomId}/available?check_in=${encodeURIComponent(checkInWithTime)}&check_out=${encodeURIComponent(checkOutWithTime)}`;
        const res = await fetch(url);
        const json = await res.json();
        
        console.log(`  → Disponible: ${json.available}`);
        
        if (json.available) {
          console.log(`✅ Fecha disponible encontrada: ${checkInStr}`);
          checkInInput.value = checkInStr;
          checkOutInput.value = checkOutStr;
          checkOutInput.setAttribute('min', checkOutStr);
          
          const nights = updateDurationDisplay(checkInStr, checkOutStr);
          await fetchPrice(checkInStr, nights);
          showNotification(`Primera fecha disponible: ${checkInStr}`, 'success');
          return;
        }
      } catch (err) {
        console.error("❌ Error verificando fecha:", checkInStr, err);
      }
      
      currentDate.setDate(currentDate.getDate() + 1);
    }
    
    console.log('❌ No se encontró fecha disponible en 30 días');
    showNotification('No hay fechas disponibles en los próximos 30 días', 'error');
  }

  // Check room availability
  async function checkAvailability(checkIn, checkOut) {
    if (!checkIn || !checkOut) return false;

    try {
      const checkInWithTime = addTimeToDate(checkIn);
      const checkOutWithTime = addTimeToDate(checkOut, true);

      const url = `/api/rooms/${roomId}/available?check_in=${encodeURIComponent(checkInWithTime)}&check_out=${encodeURIComponent(checkOutWithTime)}`;
      const res = await fetch(url);
      const json = await res.json();

      if (!json.available) {
        showNotification("La habitación no está disponible en esas fechas. Ya existe una reservación o renta.", 'error');
        checkInInput.value = "";
        checkOutInput.value = "";
        priceField.value = "";
        priceTextField.value = "";
        durationDisplay.classList.add('hidden');
        durationDisplay.classList.remove('flex');
        return false;
      }

      showNotification("Habitación disponible para las fechas seleccionadas", 'success');
      return true;
    } catch (err) {
      showNotification('Error al verificar disponibilidad', 'error');
      console.error("Error verificando disponibilidad:", err);
      return false;
    }
  }

  // Convert number to words in Spanish
  function numberToWords(num) {
    const unidades = ["", "uno", "dos", "tres", "cuatro", "cinco", "seis", "siete", "ocho", "nueve"];
    const especiales = ["diez", "once", "doce", "trece", "catorce", "quince",
                        "dieciséis", "diecisiete", "dieciocho", "diecinueve"];
    const decenas = ["", "", "veinte", "treinta", "cuarenta", "cincuenta",
                     "sesenta", "setenta", "ochenta", "noventa"];
    const centenas = ["", "ciento", "doscientos", "trescientos", "cuatrocientos",
                      "quinientos", "seiscientos", "setecientos", "ochocientos", "novecientos"];

    if (num === 0) return "cero pesos";
    if (num === 100) return "cien pesos";

    let words = "";
    let originalNum = Math.floor(num);

    if (originalNum >= 1000000) {
      return originalNum + " pesos";
    }

    if (originalNum >= 1000) {
      const miles = Math.floor(originalNum / 1000);
      if (miles === 1) {
        words += "mil";
      } else {
        words += numberToWords(miles).replace(" pesos", "") + " mil";
      }
      originalNum = originalNum % 1000;
      if (originalNum > 0) words += " ";
    }

    if (originalNum >= 100) {
      words += centenas[Math.floor(originalNum / 100)];
      originalNum = originalNum % 100;
      if (originalNum > 0) words += " ";
    }

    if (originalNum >= 20) {
      words += decenas[Math.floor(originalNum / 10)];
      if (originalNum % 10 > 0) words += " y " + unidades[originalNum % 10];
    } else if (originalNum >= 10) {
      words += especiales[originalNum - 10];
    } else if (originalNum > 0) {
      words += unidades[originalNum];
    }

    return words + " pesos";
  }

  // Validate form before submission
  async function validateForm() {
    const checkIn = checkInInput.value;
    const checkOut = checkOutInput.value;

    if (!checkIn || !checkOut) {
      showNotification('Por favor seleccione las fechas de entrada y salida', 'warning');
      return false;
    }

    if (new Date(checkOut) <= new Date(checkIn)) {
      showNotification('La fecha de salida debe ser posterior a la fecha de entrada', 'error');
      return false;
    }

    if (!priceField.value || priceField.value === '0.00') {
      showNotification('El precio no ha sido calculado correctamente', 'error');
      return false;
    }

    const isAvailable = await checkAvailability(checkIn, checkOut);
    if (!isAvailable) {
      return false;
    }

    return true;
  }

  // Event listeners
  checkInInput.addEventListener("change", async (e) => {
    const checkIn = e.target.value;
    const checkOut = checkOutInput.value;

    checkOutInput.min = checkIn;

    if (checkOut && new Date(checkOut) <= new Date(checkIn)) {
      checkOutInput.value = "";
      priceField.value = "";
      priceTextField.value = "";
      durationDisplay.classList.add('hidden');
      showNotification('Por favor seleccione una nueva fecha de salida', 'info');
    } else if (checkIn && checkOut) {
      const nights = updateDurationDisplay(checkIn, checkOut);
      const isAvailable = await checkAvailability(checkIn, checkOut);
      if (isAvailable) {
        await fetchPrice(checkIn, nights);
      }
    } else if (checkIn) {
      showNotification('Por favor seleccione una fecha de salida', 'info');
    }
  });

  checkOutInput.addEventListener("change", async (e) => {
    const checkIn = checkInInput.value;
    const checkOut = e.target.value;

    if (checkIn && checkOut) {
      if (new Date(checkOut) <= new Date(checkIn)) {
        showNotification('La fecha de salida debe ser posterior a la fecha de entrada', 'error');
        e.target.value = "";
        return;
      }

      const nights = updateDurationDisplay(checkIn, checkOut);
      const isAvailable = await checkAvailability(checkIn, checkOut);
      if (isAvailable) {
        await fetchPrice(checkIn, nights);
      }
    }
  });

  // Convertir enganche a letras automáticamente
  engancheField.addEventListener("input", (e) => {
    const amount = parseFloat(e.target.value) || 0;
    engancheTextField.value = amount > 0 ? numberToWords(amount) : '';
  });

  // Form submission validation
  document.getElementById('formReserve').addEventListener('submit', async (e) => {
    e.preventDefault();

    const isValid = await validateForm();
    if (!isValid) {
      return;
    }

    const checkInWithTime = addTimeToDate(checkInInput.value);
    const checkOutWithTime = addTimeToDate(checkOutInput.value, true);

    console.log('Enviando fechas con hora:');
    console.log('fecha_ingreso:', checkInWithTime);
    console.log('fecha_salida:', checkOutWithTime);

    const hiddenCheckIn = document.getElementById('fecha_ingreso_with_time');
    const hiddenCheckOut = document.getElementById('fecha_salida_with_time');

    if (hiddenCheckIn) hiddenCheckIn.value = checkInWithTime;
    if (hiddenCheckOut) hiddenCheckOut.value = checkOutWithTime;

    submitButton.disabled = true;
    submitButton.classList.add('opacity-50', 'cursor-not-allowed');
    submitButton.textContent = 'Creando reservación...';
    
    if (overlay) {
      overlay.classList.remove('hidden');
      const loadingMsg = document.getElementById('loadingMessage');
      if (loadingMsg) loadingMsg.textContent = 'Creando reservación...';
    }
    
    e.target.submit();
  });

  // Phone number formatting
  document.getElementById('telefono').addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 10) value = value.slice(0, 10);
    e.target.value = value;
  });

  console.log('Sistema de reservación inicializado correctamente');
});
</script>
